<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>RunNow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css"><!-- 추가: 분리된 CSS 파일 -->
</head>
<body>
    <div class="container">
        <h3 class="mb-2">2025 마라톤 일정 🏃‍♂️</h3>
        <div class="mb-4 filter">
          <!-- 지역 필터 드롭다운 -->
          <div class="d-flex align-items-center mb-2 gap-2">
            <div class="dropdown d-inline-block">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" id="regionDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                전체 지역
              </button>
              <ul class="dropdown-menu" aria-labelledby="regionDropdownBtn" id="regionDropdownMenu" style="max-height:260px;overflow:auto;">
                <li><a class="dropdown-item region-filter-item" href="#" data-region="all">전체 지역</a></li>
                <li><a class="dropdown-item region-filter-item" href="#" data-region="metro">수도권</a></li>
                <li><a class="dropdown-item region-filter-item" href="#" data-region="nonmetro">비수도권</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- 동적 지역 옵션이 이 아래에 추가됩니다 -->
              </ul>
            </div>
            <!-- 코스 필터 드롭다운 -->
            <div class="dropdown d-inline-block">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" id="courseDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                전체 코스
              </button>
              <ul class="dropdown-menu" aria-labelledby="courseDropdownBtn" id="courseDropdownMenu"></ul>
            </div>
            <!-- 지난대회 보기 스위치 -->
            <div class="form-check form-switch d-flex align-items-center">
                <input class="form-check-input" type="checkbox" id="showPastSwitch">
                <label class="form-check-label ms-2" for="showPastSwitch">지난대회 보기</label>
            </div>
          </div>
        </div>
        <div id="marathon-list"></div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


<script type="text/javascript">
const csvUrl = 'https://docs.google.com/spreadsheets/d/1z67BXtYTMB0PySBjvTMz_IOiOy3JCKCx/export?format=csv';

// 수도권 지역명 리스트
const metroRegions = ['서울', '경기', '인천'];

let allCards = [];

Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    const data = results.data;
    $('#marathon-list').empty();
    allCards = [];
    let allRegions = new Set();
    let allCourses = new Set();
    let lastYear = new Date().getFullYear(); // 현재 연도

    data.forEach((row, idx) => {
        const region = (row.Location || '').split(',')[0].trim();
        if (region) allRegions.add(region);

        // 코스 정보 수집 (Full, Half, 10km, 5km 등)
        if (row.Course) {
            row.Course.split(',').forEach(c => {
                const course = c.trim();
                if (course) allCourses.add(course);
            });
        }

        const isMetro = metroRegions.includes(region);

        // 날짜 비교용: Date1이 MM.DD 또는 YYYY.MM.DD 형식이라고 가정
        let eventDate = null;
        if (row.Date1) {
            let today = new Date();
            let year = today.getFullYear();
            let dateStr = row.Date1.trim().replace(/\s/g, ''); // 공백 제거
            if (/^\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // MM.DD 형식
                eventDate = new Date(year, Number(dateStr.split('.')[0]) - 1, Number(dateStr.split('.')[1]));
            } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // YYYY.MM.DD 형식
                let parts = dateStr.split('.');
                eventDate = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
        }

        // 카드 HTML 생성
        const hasLogo = row.logo && row.logo.trim() !== '';
        const avatarOrLogo = hasLogo
          ? `<img src="${row.logo}" alt="로고" style="width:48px; height:48px; object-fit:cover; border-radius:50%; background:#fff;">`
          : `<div class="avatar text-white rounded-circle d-flex align-items-center justify-content-center mx-auto"
                style="width:48px; height:48px; font-size:1.3em; background:${getAvatarColor(row.Name)};">
                ${getAvatarText(row.Name)}
            </div>`;

        const cardHtml = `
            <div class="card border-light mb-3 shadow-sm rounded-4 bg-white marathon-card"
                data-region-type="${isMetro ? 'metro' : 'nonmetro'}"
                data-region-name="${region}"
                data-course="${(row.Course || '').replace(/\s/g,'')}"
                data-eventdate="${eventDate ? eventDate.toISOString().slice(0,10) : ''}">
              <div class="card-body p-3 d-flex flex-row align-items-start">
                <!-- 날짜+요일, 아바타/로고 + 구분선 -->
                <div class="d-flex flex-column align-items-center justify-content-start pe-3"
                    style="min-width:72px;">
                  <div class="fw-semibold text-center mb-2" style="line-height:1.1;">
                    ${formatDateWithDay(row.Date1)}
                  </div>
                  <div class="flex-grow-1 d-flex align-items-center justify-content-center" style="min-height:48px;">
                    ${avatarOrLogo}
                  </div>
                </div>
                <div class="flex-grow-1 ps-3 border-start"" style="border-color: #f0f0f0 !important;">
                  <div class="d-flex justify-content-between align-items-start mb-1 gap-2">
                    <div class="d-flex align-items-center">
                      <h5 class="mb-0 fw-bold">${row.Name}</h5>
                    </div>
                    <div class="status d-flex align-items-start"
                         data-regstart="${row.RegStart || ''}"
                         data-regend="${row.RegEnd || ''}">
                      ${row.RegStart && row.RegEnd ? row.RegStart + '~' + row.RegEnd : ''}
                    </div>
                  </div>
                  <div class="text-muted small mb-1">${row.Location}</div>
                  <div class="course-tags" data-course="${row.Course}"></div>
                </div>
              </div>
            </div>
        `;
        allCards.push(cardHtml);

        // 카드 생성 직전, 이후년도 타이틀 삽입
        if (eventDate && eventDate.getFullYear() > lastYear) {
            $('#marathon-list').append(`
                <div class="year-title my-4 text-center fw-bold" style="font-size:1.2em; color:#888;">
                    ${eventDate.getFullYear()}년 대회
                </div>
            `);
            lastYear = eventDate.getFullYear();
        }

        $('#marathon-list').append(cardHtml);
    });

    // 태그 처리
    $('.course-tags').each(function () {
        const courseStr = $(this).data('course');
        if (!courseStr) return;
        const courses = courseStr.split(',').map(c => c.trim());
        const tags = courses.map(course => {
          let tagClass = 'text-bg-light';
          if (/half/i.test(course)) tagClass = 'text-bg-light';
          else if (/full/i.test(course)) tagClass = 'text-bg-light';
          return `<span class="badge rounded-pill ${tagClass}">${course}</span>`;
        });
        $(this).html(tags.join(' '));
    });

    // 지난대회일 경우 상태값을 '종료'로 변경
    $('.marathon-card').each(function () {
        const $card = $(this);
        const eventDateStr = $card.data('eventdate');
        const statusDiv = $card.find('.status');
        const regStartStr = statusDiv.data('regstart') || statusDiv.text().split('~')[0].trim();
        const regEndStr = statusDiv.data('regend') || statusDiv.text().split('~')[1]?.trim();
        let statusHtml = '';
        const now = new Date();
        now.setSeconds(0,0);

        // 1. 대회 날짜가 지났으면 '종료'
        if (eventDateStr) {
            const eventDate = new Date(eventDateStr);
            if (eventDate < now) {
                statusHtml = `<span class="badge text-bg-light">종료</span>`;
                statusDiv.html(statusHtml);
                return;
            }
        }

        // 2. 접수 시작/마감 처리
        let regStart = parseDate(regStartStr);
        let regEnd = parseDate(regEndStr);

        if (regStart && now < regStart) {
            // 접수 시작 전
            const diff = Math.ceil((regStart - now) / (1000 * 60 * 60 * 24));
            statusHtml = `<span class="badge text-bg-info">접수시작 ${diff}일전</span>`;
        } else if (regEnd && now <= regEnd) {
            // 접수 마감 전
            const diffMs = regEnd - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffDays >= 1) {
                statusHtml = `<span class="badge text-bg-warning">마감 ${diffDays}일전</span>`;
            } else {
                statusHtml = `<span class="badge text-bg-warning">마감 ${diffHours}시간전</span>`;
            }
        } else if (regEnd && now > regEnd) {
            // 접수 마감
            statusHtml = `<span class="badge text-bg-light">접수마감</span>`;
        } else {
            statusHtml = '';
        }

        statusDiv.html(statusHtml);

        // 날짜 파싱 함수 (YYYY.MM.DD [오전/오후 HH:MM:SS] 지원)
        function parseDate(str) {
            if (!str) return null;
            str = str.trim();
            // 예: 2025. 6. 14 오전 12:00:00 또는 2025.06.14 오후 3:30:00
            const regex = /^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})(?:\s*(오전|오후)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/;
            const match = str.match(regex);
            if (match) {
                let year = Number(match[1]);
                let month = Number(match[2]) - 1;
                let day = Number(match[3]);
                let hour = 0, minute = 0, second = 0;
                if (match[4]) {
                    hour = Number(match[5]);
                    if (match[4] === '오후' && hour < 12) hour += 12;
                    if (match[4] === '오전' && hour === 12) hour = 0;
                    minute = Number(match[6]);
                    second = match[7] ? Number(match[7]) : 0;
                }
                return new Date(year, month, day, hour, minute, second);
            }
            // 기본 YYYY.MM.DD
            const parts = str.split('.');
            if (parts.length >= 3) {
                return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
            return null;
        }
    });

    // 지역 드롭다운 동적 옵션 추가
    const $regionMenu = $('#regionDropdownMenu');
    $regionMenu.find('.dynamic-region').remove();
    Array.from(allRegions).sort().forEach(region => {
        $regionMenu.append(`<li class="dynamic-region"><a class="dropdown-item region-filter-item" href="#" data-region="${region}">${region}</a></li>`);
    });

    // 코스 드롭다운 고정 옵션만 사용 (동적 생성 X)
    const $courseMenu = $('#courseDropdownMenu');
    $courseMenu.empty();

    // 코스 드롭다운 고정 옵션에 트레일러닝 추가
    const courseOptions = [
        { value: 'all', label: '전체 코스' },
        { value: 'Full', label: 'Full' },
        { value: 'Half', label: 'Half' },
        { value: '10km', label: '10km' },
        { value: '5km', label: '5km이하' },
        { value: 'trail', label: '트레일러닝' }, // 추가
        { value: 'etc', label: '기타' }
    ];

    courseOptions.forEach(item => {
        $courseMenu.append(`
            <li>
              <label class="dropdown-item mb-1">
                <input type="checkbox" class="form-check-input me-1 course-filter-checkbox" value="${item.value}"> ${item.label}
              </label>
            </li>
        `);
    });

    // 지역 필터 드롭다운 이벤트
    $(document).on('click', '.region-filter-item', function(e) {
        e.preventDefault();
        const region = $(this).data('region');
        $('#regionDropdownBtn').text(region === 'all' ? '전체 지역' : $(this).text());
        $('#regionDropdownBtn').data('selected-region', region);
        filterCards();
    });

    // 코스 필터 드롭다운 이벤트 (다중선택)
    $(document).on('change', '.course-filter-checkbox', function() {
        // "전체 코스" 체크 시 나머지 해제, 나머지 체크 시 "전체 코스" 해제
        if ($(this).val() === 'all') {
            if ($(this).is(':checked')) {
                $('.course-filter-checkbox').not(this).prop('checked', false);
            }
        } else {
            $('.course-filter-checkbox[value="all"]').prop('checked', false);
        }
        // 버튼 텍스트 변경
        const checked = $('.course-filter-checkbox:checked').map(function(){ return $(this).parent().text().trim(); }).get();
        $('#courseDropdownBtn').text(checked.length === 0 || checked.includes('전체 코스') ? '전체 코스' : checked.join(', '));
        filterCards();
    });

    // 지난대회 보기 스위치 이벤트
    $('#showPastSwitch').on('change', function() {
        filterCards();
    });

    // 최초 로딩 시에도 필터 적용
    $(function() {
        filterCards();
    });

    function filterCards() {
        const selectedRegion = $('#regionDropdownBtn').data('selected-region') || 'all';
        const checkedCourses = $('.course-filter-checkbox:checked').map(function(){ return $(this).val(); }).get();
        const showPast = $('#showPastSwitch').is(':checked');
        const today = new Date();
        today.setHours(0,0,0,0);

        $('.marathon-card').each(function() {
            const cardRegionType = $(this).data('region-type');
            const cardRegionName = $(this).data('region-name');
            const courseRaw = ($(this).data('course') || '').toLowerCase();
            let show = true;

            // 지역 필터
            if (selectedRegion === 'metro') {
                show = show && (cardRegionType === 'metro');
            } else if (selectedRegion === 'nonmetro') {
                show = show && (cardRegionType === 'nonmetro');
            } else if (selectedRegion !== 'all') {
                show = show && (cardRegionName === selectedRegion);
            }

            // 코스 필터 (다중선택)
            if (checkedCourses.length > 0 && !checkedCourses.includes('all')) {
                let courseMatch = false;
                // 코스 문자열을 배열로 분리 (공백 제거)
                const courseArr = courseRaw.split(',').map(c => c.trim());
                checkedCourses.forEach(courseFilter => {
                    if (courseFilter === 'Full' && courseArr.includes('full')) courseMatch = true;
                    else if (courseFilter === 'Half' && courseArr.includes('half')) courseMatch = true;
                    else if (courseFilter === '10km' && courseArr.includes('10km')) courseMatch = true;
                    else if (courseFilter === '5km' && courseArr.includes('5km')) courseMatch = true;
                    else if (courseFilter === 'trail') {
                        // 대회명에 '트레일' 또는 'trail' 포함 시만 표시
                        const title = $(this).find('h5').text();
                        if (/트레일|trail/i.test(title)) courseMatch = true;
                    }
                    else if (courseFilter === 'etc' && courseArr.every(c => !['full', 'half', '10km', '5km', 'trail'].includes(c))) courseMatch = true;
                });
                show = show && courseMatch;
            }

            // 지난대회 필터 (기본적으로 숨김)
            if (!showPast) {
                const eventDateStr = $(this).data('eventdate');
                if (eventDateStr) {
                    const eventDate = new Date(eventDateStr);
                    if (eventDate < today) show = false;
                }
            }

            $(this).toggle(show);
        });
    }

    // 날짜+요일 포맷 함수 (M.DD.요일 형식)
    function formatDateWithDay(dateStr) {
        if (!dateStr) return '';
        const today = new Date();
        let year = today.getFullYear();
        let date = null;
        let str = dateStr.trim().replace(/\s/g, '');
        if (/^\d{1,2}\.\d{1,2}$/.test(str)) {
            // MM.DD
            date = new Date(year, Number(str.split('.')[0]) - 1, Number(str.split('.')[1]));
        } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(str)) {
            // YYYY.MM.DD
            let parts = str.split('.');
            date = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        }
        if (!date || isNaN(date)) return dateStr;
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        return `${date.getMonth() + 1}.${date.getDate()}.${days[date.getDay()]}`;
    }

    // 대회명 앞 두글자 아바타
    function getAvatarText(name) {
        if (!name) return '';
        return name.trim().slice(0, 2);
    }

    // 아바타 색상 생성 (HSL 포맷)
    function getAvatarColor(name) {
        // HSL 색상: 0~360(색상), 25~35%(채도), 70~78%(명도)로 제한 (저채도, 밝은 파스텔)
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash) % 360;
        const saturation = 25 + (Math.abs(hash) % 11); // 25~35%
        const lightness = 70 + (Math.abs(hash) % 9);  // 70~78%
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }
  }
});
</script>

</body>
</html>