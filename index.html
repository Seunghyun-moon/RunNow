<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>RunNow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css"><!-- ì¶”ê°€: ë¶„ë¦¬ëœ CSS íŒŒì¼ -->
</head>
<body>
    <div class="container">
        <h3 class="mb-2">2025 ë§ˆë¼í†¤ ì¼ì • ğŸƒâ€â™‚ï¸</h3>
        <div class="mb-4 filter">
          <!-- ì§€ì—­ í•„í„° ë“œë¡­ë‹¤ìš´ -->
          <div class="d-flex align-items-center mb-2 gap-2">
            <div class="dropdown d-inline-block">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" id="regionDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                ì „ì²´ ì§€ì—­
              </button>
              <ul class="dropdown-menu" aria-labelledby="regionDropdownBtn" id="regionDropdownMenu" style="max-height:260px;overflow:auto;">
                <li><a class="dropdown-item region-filter-item" href="#" data-region="all">ì „ì²´ ì§€ì—­</a></li>
                <li><a class="dropdown-item region-filter-item" href="#" data-region="metro">ìˆ˜ë„ê¶Œ</a></li>
                <li><a class="dropdown-item region-filter-item" href="#" data-region="nonmetro">ë¹„ìˆ˜ë„ê¶Œ</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- ë™ì  ì§€ì—­ ì˜µì…˜ì´ ì´ ì•„ë˜ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
              </ul>
            </div>
            <!-- ì½”ìŠ¤ í•„í„° ë“œë¡­ë‹¤ìš´ -->
            <div class="dropdown d-inline-block">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" id="courseDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                ì „ì²´ ì½”ìŠ¤
              </button>
              <ul class="dropdown-menu" aria-labelledby="courseDropdownBtn" id="courseDropdownMenu"></ul>
            </div>
            <!-- ì§€ë‚œëŒ€íšŒ ë³´ê¸° ìŠ¤ìœ„ì¹˜ -->
            <div class="form-check form-switch d-flex align-items-center">
                <input class="form-check-input" type="checkbox" id="showPastSwitch">
                <label class="form-check-label ms-2" for="showPastSwitch">ì§€ë‚œëŒ€íšŒ ë³´ê¸°</label>
            </div>
          </div>
        </div>
        <div id="marathon-list"></div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


<script type="text/javascript">
const csvUrl = 'https://docs.google.com/spreadsheets/d/1z67BXtYTMB0PySBjvTMz_IOiOy3JCKCx/export?format=csv';

// ìˆ˜ë„ê¶Œ ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸
const metroRegions = ['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ'];

let allCards = [];

Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    const data = results.data;
    $('#marathon-list').empty();
    allCards = [];
    let allRegions = new Set();
    let allCourses = new Set();

    data.forEach((row, idx) => {
        const region = (row.Location || '').split(',')[0].trim();
        if (region) allRegions.add(region);

        // ì½”ìŠ¤ ì •ë³´ ìˆ˜ì§‘ (Full, Half, 10km, 5km ë“±)
        if (row.Course) {
            row.Course.split(',').forEach(c => {
                const course = c.trim();
                if (course) allCourses.add(course);
            });
        }

        const isMetro = metroRegions.includes(region);

        // ë‚ ì§œ ë¹„êµìš©: Date1ì´ MM.DD ë˜ëŠ” YYYY.MM.DD í˜•ì‹ì´ë¼ê³  ê°€ì •
        let eventDate = null;
        if (row.Date1) {
            let today = new Date();
            let year = today.getFullYear();
            let dateStr = row.Date1.trim().replace(/\s/g, ''); // ê³µë°± ì œê±°
            if (/^\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // MM.DD í˜•ì‹
                eventDate = new Date(year, Number(dateStr.split('.')[0]) - 1, Number(dateStr.split('.')[1]));
            } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // YYYY.MM.DD í˜•ì‹
                let parts = dateStr.split('.');
                eventDate = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
        }

        // ì¹´ë“œ HTML ìƒì„±
        const hasLogo = row.logo && row.logo.trim() !== '';
        const avatarOrLogo = hasLogo
          ? `<img src="${row.logo}" alt="ë¡œê³ " style="width:48px; height:48px; object-fit:cover; border-radius:50%; background:#fff;">`
          : `<div class="avatar text-white rounded-circle d-flex align-items-center justify-content-center mx-auto"
                style="width:48px; height:48px; font-size:1.3em; background:${getAvatarColor(row.Name)};">
                ${getAvatarText(row.Name)}
            </div>`;

        const cardHtml = `
            <div class="card border-light mb-3 shadow-sm rounded-4 bg-white marathon-card"
                data-region-type="${isMetro ? 'metro' : 'nonmetro'}"
                data-region-name="${region}"
                data-course="${(row.Course || '').replace(/\s/g,'')}"
                data-eventdate="${eventDate ? eventDate.toISOString().slice(0,10) : ''}">
              <div class="card-body p-3 d-flex flex-row align-items-start">
                <!-- ë‚ ì§œ+ìš”ì¼, ì•„ë°”íƒ€/ë¡œê³  + êµ¬ë¶„ì„  -->
                <div class="d-flex flex-column align-items-center justify-content-start pe-3 border-end"
                    style="min-width:72px; border-color: #f0f0f0 !important;">
                  <div class="fw-semibold text-center mb-2 mt-1" style="line-height:1.1;">
                    ${formatDateWithDay(row.Date1)}
                  </div>
                  <div class="flex-grow-1 d-flex align-items-center justify-content-center" style="min-height:48px;">
                    ${avatarOrLogo}
                  </div>
                </div>
                <div class="flex-grow-1 ps-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="d-flex align-items-center">
                      <h5 class="mb-0 fw-bold">${row.Name}</h5>
                    </div>
                    <div class="status">${row.Status ? row.Status : ''}</div>
                  </div>
                  <div class="text-muted small mb-1">${row.Location}</div>
                  <div class="course-tags" data-course="${row.Course}"></div>
                </div>
              </div>
            </div>
        `;
        allCards.push(cardHtml);
        $('#marathon-list').append(cardHtml);
    });

    // íƒœê·¸ ì²˜ë¦¬
    $('.course-tags').each(function () {
        const courseStr = $(this).data('course');
        if (!courseStr) return;
        const courses = courseStr.split(',').map(c => c.trim());
        const tags = courses.map(course => {
          let tagClass = 'text-bg-light';
          if (/half/i.test(course)) tagClass = 'text-bg-light';
          else if (/full/i.test(course)) tagClass = 'text-bg-light';
          return `<span class="badge rounded-pill ${tagClass}">${course}</span>`;
        });
        $(this).html(tags.join(' '));
    });

    // ìƒíƒœ ì²˜ë¦¬
    $('.status').each(function () {
        const statusText = $(this).text().trim();
        const statusClassMap = {
          'ë§ˆê°': 'text-bg-light',
          'ì ‘ìˆ˜ì¤‘': 'text-bg-warning',
          'ì˜ˆì •': 'text-bg-dark'
        };
        const badgeClass = statusClassMap[statusText] || 'text-bg-secondary';
        $(this).html(`<span class="badge ${badgeClass}">${statusText}</span>`);
    });

    // ì§€ì—­ ë“œë¡­ë‹¤ìš´ ë™ì  ì˜µì…˜ ì¶”ê°€
    const $regionMenu = $('#regionDropdownMenu');
    $regionMenu.find('.dynamic-region').remove();
    Array.from(allRegions).sort().forEach(region => {
        $regionMenu.append(`<li class="dynamic-region"><a class="dropdown-item region-filter-item" href="#" data-region="${region}">${region}</a></li>`);
    });

    // ì½”ìŠ¤ ë“œë¡­ë‹¤ìš´ ê³ ì • ì˜µì…˜ë§Œ ì‚¬ìš© (ë™ì  ìƒì„± X)
    const $courseMenu = $('#courseDropdownMenu');
    $courseMenu.empty();

    const courseOptions = [
        { value: 'all', label: 'ì „ì²´ ì½”ìŠ¤' },
        { value: 'Full', label: 'Full' },
        { value: 'Half', label: 'Half' },
        { value: '10km', label: '10km' },
        { value: '5km', label: '5kmì´í•˜' },
        { value: 'etc', label: 'ê¸°íƒ€' }
    ];

    courseOptions.forEach(item => {
        $courseMenu.append(`
            <li>
              <label class="dropdown-item mb-1">
                <input type="checkbox" class="form-check-input me-1 course-filter-checkbox" value="${item.value}"> ${item.label}
              </label>
            </li>
        `);
    });

    // ì§€ì—­ í•„í„° ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸
    $(document).on('click', '.region-filter-item', function(e) {
        e.preventDefault();
        const region = $(this).data('region');
        $('#regionDropdownBtn').text(region === 'all' ? 'ì „ì²´ ì§€ì—­' : $(this).text());
        $('#regionDropdownBtn').data('selected-region', region);
        filterCards();
    });

    // ì½”ìŠ¤ í•„í„° ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ (ë‹¤ì¤‘ì„ íƒ)
    $(document).on('change', '.course-filter-checkbox', function() {
        // "ì „ì²´ ì½”ìŠ¤" ì²´í¬ ì‹œ ë‚˜ë¨¸ì§€ í•´ì œ, ë‚˜ë¨¸ì§€ ì²´í¬ ì‹œ "ì „ì²´ ì½”ìŠ¤" í•´ì œ
        if ($(this).val() === 'all') {
            if ($(this).is(':checked')) {
                $('.course-filter-checkbox').not(this).prop('checked', false);
            }
        } else {
            $('.course-filter-checkbox[value="all"]').prop('checked', false);
        }
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const checked = $('.course-filter-checkbox:checked').map(function(){ return $(this).parent().text().trim(); }).get();
        $('#courseDropdownBtn').text(checked.length === 0 || checked.includes('ì „ì²´ ì½”ìŠ¤') ? 'ì „ì²´ ì½”ìŠ¤' : checked.join(', '));
        filterCards();
    });

    // ì§€ë‚œëŒ€íšŒ ë³´ê¸° ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸
    $('#showPastSwitch').on('change', function() {
        filterCards();
    });

    // ìµœì´ˆ ë¡œë”© ì‹œì—ë„ í•„í„° ì ìš©
    $(function() {
        filterCards();
    });

    function filterCards() {
        const selectedRegion = $('#regionDropdownBtn').data('selected-region') || 'all';
        const checkedCourses = $('.course-filter-checkbox:checked').map(function(){ return $(this).val(); }).get();
        const showPast = $('#showPastSwitch').is(':checked');
        const today = new Date();
        today.setHours(0,0,0,0);

        $('.marathon-card').each(function() {
            const cardRegionType = $(this).data('region-type');
            const cardRegionName = $(this).data('region-name');
            const courseRaw = ($(this).data('course') || '').toLowerCase();
            let show = true;

            // ì§€ì—­ í•„í„°
            if (selectedRegion === 'metro') {
                show = show && (cardRegionType === 'metro');
            } else if (selectedRegion === 'nonmetro') {
                show = show && (cardRegionType === 'nonmetro');
            } else if (selectedRegion !== 'all') {
                show = show && (cardRegionName === selectedRegion);
            }

            // ì½”ìŠ¤ í•„í„° (ë‹¤ì¤‘ì„ íƒ)
            if (checkedCourses.length > 0 && !checkedCourses.includes('all')) {
                let courseMatch = false;
                // ì½”ìŠ¤ ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë¶„ë¦¬ (ê³µë°± ì œê±°)
                const courseArr = courseRaw.split(',').map(c => c.trim());
                checkedCourses.forEach(courseFilter => {
                    if (courseFilter === 'Full' && courseArr.includes('full')) courseMatch = true;
                    else if (courseFilter === 'Half' && courseArr.includes('half')) courseMatch = true;
                    else if (courseFilter === '10km' && courseArr.includes('10km')) courseMatch = true;
                    else if (courseFilter === '5km' && courseArr.includes('5km')) courseMatch = true;
                    else if (courseFilter === 'etc' && courseArr.every(c => !['full', 'half', '10km', '5km'].includes(c))) courseMatch = true;
                });
                show = show && courseMatch;
            }

            // ì§€ë‚œëŒ€íšŒ í•„í„° (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€)
            if (!showPast) {
                const eventDateStr = $(this).data('eventdate');
                if (eventDateStr) {
                    const eventDate = new Date(eventDateStr);
                    if (eventDate < today) show = false;
                }
            }

            $(this).toggle(show);
        });
    }

    // ë‚ ì§œ+ìš”ì¼ í¬ë§· í•¨ìˆ˜ (M.DD.ìš”ì¼ í˜•ì‹)
    function formatDateWithDay(dateStr) {
        if (!dateStr) return '';
        const today = new Date();
        let year = today.getFullYear();
        let date = null;
        let str = dateStr.trim().replace(/\s/g, '');
        if (/^\d{1,2}\.\d{1,2}$/.test(str)) {
            // MM.DD
            date = new Date(year, Number(str.split('.')[0]) - 1, Number(str.split('.')[1]));
        } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(str)) {
            // YYYY.MM.DD
            let parts = str.split('.');
            date = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        }
        if (!date || isNaN(date)) return dateStr;
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        return `${date.getMonth() + 1}.${date.getDate()}.${days[date.getDay()]}`;
    }

    // ëŒ€íšŒëª… ì• ë‘ê¸€ì ì•„ë°”íƒ€
    function getAvatarText(name) {
        if (!name) return '';
        return name.trim().slice(0, 2);
    }

    // ì•„ë°”íƒ€ ìƒ‰ìƒ ìƒì„± (HSL í¬ë§·)
    function getAvatarColor(name) {
        // HSL ìƒ‰ìƒ: 0~360(ìƒ‰ìƒ), 25~35%(ì±„ë„), 70~78%(ëª…ë„)ë¡œ ì œí•œ (ì €ì±„ë„, ë°ì€ íŒŒìŠ¤í…”)
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash) % 360;
        const saturation = 25 + (Math.abs(hash) % 11); // 25~35%
        const lightness = 70 + (Math.abs(hash) % 9);  // 70~78%
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }
  }
});
</script>

</body>
</html>