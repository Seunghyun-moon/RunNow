<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>RunNow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css"><!-- ì¶”ê°€: ë¶„ë¦¬ëœ CSS íŒŒì¼ -->
</head>
<body>
    <header>
      <h4><strong>Run Now</strong> ğŸƒâ€â™‚ï¸ 2025 ë§ˆë¼í†¤</h4>
    </header>

    <!-- ì§€ì—­ í•„í„° ë“œë¡­ë‹¤ìš´ -->
    <div class="filter d-flex align-items-center mb-2 gap-2">
      <div class="dropdown d-inline-block">
        <button class="btn btn-sm btn-dark dropdown-toggle" type="button" id="regionDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
          ì§€ì—­
        </button>
        <ul class="dropdown-menu" aria-labelledby="regionDropdownBtn" id="regionDropdownMenu" style="max-height:260px;overflow:auto;">
          <li><a class="dropdown-item region-filter-item" href="#" data-region="all">ì „ì²´ ì§€ì—­</a></li>
          <li><a class="dropdown-item region-filter-item" href="#" data-region="metro">ìˆ˜ë„ê¶Œ</a></li>
          <li><a class="dropdown-item region-filter-item" href="#" data-region="nonmetro">ë¹„ìˆ˜ë„ê¶Œ</a></li>
          <li><hr class="dropdown-divider"></li>
          <!-- ë™ì  ì§€ì—­ ì˜µì…˜ì´ ì´ ì•„ë˜ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </ul>
      </div>
      <!-- ì½”ìŠ¤ í•„í„° ë“œë¡­ë‹¤ìš´ -->
      <div class="dropdown d-inline-block">
        <button class="btn btn-sm btn-dark dropdown-toggle" type="button" id="courseDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
          ì½”ìŠ¤
        </button>
        <ul class="dropdown-menu" aria-labelledby="courseDropdownBtn" id="courseDropdownMenu"></ul>
      </div>
      <!-- ì§€ë‚œëŒ€íšŒ ë³´ê¸° ìŠ¤ìœ„ì¹˜ -->
      <div class="form-check form-switch d-flex align-items-center">
          <input class="form-check-input" type="checkbox" id="showPastSwitch">
          <label class="form-check-label ms-2" for="showPastSwitch">ì§€ë‚œëŒ€íšŒ ë³´ê¸°</label>
      </div>

    </div>
    <div id="marathon-list"></div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


<script type="text/javascript">
const csvUrl = 'https://docs.google.com/spreadsheets/d/1z67BXtYTMB0PySBjvTMz_IOiOy3JCKCx/export?format=csv';

// ìˆ˜ë„ê¶Œ ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸
const metroRegions = ['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ'];

let allCards = [];

Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    const data = results.data;
    $('#marathon-list').empty();
    allCards = [];
    let allRegions = new Set();
    let allCourses = new Set();
    let lastYear = new Date().getFullYear(); // í˜„ì¬ ì—°ë„

    data.forEach((row, idx) => {
        const region = (row.Location || '').split(',')[0].trim();
        if (region) allRegions.add(region);

        // ì½”ìŠ¤ ì •ë³´ ìˆ˜ì§‘ (Full, Half, 10km, 5km ë“±)
        if (row.Course) {
            row.Course.split(',').forEach(c => {
                const course = c.trim();
                if (course) allCourses.add(course);
            });
        }

        const isMetro = metroRegions.includes(region);

        // ë‚ ì§œ ë¹„êµìš©: Date1ì´ MM.DD ë˜ëŠ” YYYY.MM.DD í˜•ì‹ì´ë¼ê³  ê°€ì •
        let eventDate = null;
        if (row.Date1) {
            let today = new Date();
            let year = today.getFullYear();
            let dateStr = row.Date1.trim().replace(/\s/g, ''); // ê³µë°± ì œê±°
            if (/^\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // MM.DD í˜•ì‹
                eventDate = new Date(year, Number(dateStr.split('.')[0]) - 1, Number(dateStr.split('.')[1]));
            } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                // YYYY.MM.DD í˜•ì‹
                let parts = dateStr.split('.');
                eventDate = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
        }

        // ì¹´ë“œ HTML ìƒì„±
        const hasLogo = row.logo && row.logo.trim() !== '';
        const avatarOrLogo = hasLogo
          ? `<img src="${row.logo}" alt="ë¡œê³ " style="width:48px; height:48px; object-fit:cover; border-radius:50%; background:#fff;">`
          : `<div class="avatar rounded-circle d-flex align-items-center justify-content-center mx-auto ${getAvatarColorClass(row.Name)}"
                 style="width:48px; height:48px; font-size:1.3em;">
                ${getAvatarText(row.Name)}
             </div>`;

        const cardHtml = `
            <div class="card border-light mb-3 shadow-sm rounded-4 bg-white marathon-card"
                data-region-type="${isMetro ? 'metro' : 'nonmetro'}"
                data-region-name="${region}"
                data-course="${(row.Course || '').replace(/\s/g,'')}"
                data-eventdate="${eventDate ? eventDate.toISOString().slice(0,10) : ''}"
                ${row.link && row.link.trim() !== '' ? `data-link="${row.link.trim()}" style="cursor:pointer;"` : ''}>
              <div class="card-body p-3 d-flex flex-row align-items-start">
                <!-- ë‚ ì§œ+ìš”ì¼, ì•„ë°”íƒ€/ë¡œê³  + êµ¬ë¶„ì„  -->
                <div class="d-flex flex-column align-items-center justify-content-start pe-3"
                    style="min-width:74px;">
                  <div class="fw-semibold text-center mb-2" style="line-height:1.1;">
                    ${formatDateWithDay(row.Date1)}
                  </div>
                  <div class="flex-grow-1 d-flex align-items-center justify-content-center" style="min-height:48px;">
                    ${avatarOrLogo}
                  </div>
                </div>
                <div class="flex-grow-1 ps-3 border-start"" style="border-color: #f0f0f0 !important;">
                  <div class="d-flex justify-content-between align-items-start mb-1 gap-2">
                    <div class="d-flex align-items-center">
                      <h5 class="mb-0 fw-bold">${row.Name}</h5>
                    </div>
                    <div class="status d-flex align-items-start"
                         data-regstart="${row.RegStart || ''}"
                         data-regend="${row.RegEnd || ''}">
                      ${row.RegStart && row.RegEnd ? row.RegStart + '~' + row.RegEnd : ''}
                    </div>
                  </div>
                  <div class="text-muted small mb-1">${row.Location}</div>
                  <div class="d-flex align-items-center justify-content-between">
                  <div class="course-tags" data-course="${row.Course}"></div>
                  ${
                    row.link && row.link.trim() !== ''
                      ? ''
                      : `<span class="opacity-50 ms-2" title="í™ˆí˜ì´ì§€ ì—†ìŒ" style="font-size:1.4em; user-select:none; display:flex; align-items:center;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 -960 960 960" width="22" fill="#bdbdbd">
                              <path d="m770-302-60-62q40-11 65-42.5t25-73.5q0-50-35-85t-85-35H520v-80h160q83 0 141.5 58.5T880-480q0 57-29.5 105T770-302ZM634-440l-80-80h86v80h-6ZM792-56 56-792l56-56 736 736-56 56ZM440-280H280q-83 0-141.5-58.5T80-480q0-69 42-123t108-71l74 74h-24q-50 0-85 35t-35 85q0 50 35 85t85 35h160v80ZM320-440v-80h65l79 80H320Z"/>
                            </svg>
                         </span>`
                  }
                </div>
              </div>
            </div>
        `;
        allCards.push(cardHtml);

        // ì¹´ë“œ ìƒì„± ì§ì „, ì´í›„ë…„ë„ íƒ€ì´í‹€ ì‚½ì…
        if (eventDate && eventDate.getFullYear() > lastYear) {
            $('#marathon-list').append(`
                <div class="year-title my-4 text-center fw-bold" style="font-size:1.2em; color:#888;">
                    ${eventDate.getFullYear()}ë…„ ëŒ€íšŒ
                </div>
            `);
            lastYear = eventDate.getFullYear();
        }

        $('#marathon-list').append(cardHtml);
    });

    // íƒœê·¸ ì²˜ë¦¬
    $('.course-tags').each(function () {
        const courseStr = $(this).data('course');
        if (!courseStr) return;
        const courses = courseStr.split(',').map(c => c.trim());
        const tags = courses.map(course => {
          let tagClass = 'text-bg-light';
          if (/half/i.test(course)) tagClass = 'text-bg-light';
          else if (/full/i.test(course)) tagClass = 'text-bg-light';
          return `<span class="badge rounded-pill ${tagClass}">${course}</span>`;
        });
        $(this).html(tags.join(' '));
    });

    // ì§€ë‚œëŒ€íšŒì¼ ê²½ìš° ìƒíƒœê°’ì„ 'ì¢…ë£Œ'ë¡œ ë³€ê²½
    $('.marathon-card').each(function () {
        const $card = $(this);
        const eventDateStr = $card.data('eventdate');
        const statusDiv = $card.find('.status');
        const regStartStr = statusDiv.data('regstart') || statusDiv.text().split('~')[0].trim();
        const regEndStr = statusDiv.data('regend') || statusDiv.text().split('~')[1]?.trim();
        let statusHtml = '';
        const now = new Date();
        now.setSeconds(0,0);

        // 1. ëŒ€íšŒ ë‚ ì§œê°€ ì§€ë‚¬ìœ¼ë©´ 'ì¢…ë£Œ'
        if (eventDateStr) {
            const eventDate = new Date(eventDateStr);
            if (eventDate < now) {
                statusHtml = `<span class="badge text-bg-light">ì¢…ë£Œ</span>`;
                statusDiv.html(statusHtml);
                return;
            }
        }

        // 2. ì ‘ìˆ˜ ì‹œì‘/ë§ˆê° ì²˜ë¦¬
        let regStart = parseDate(regStartStr);
        let regEnd = parseDate(regEndStr);

        if (regStart && now < regStart) {
            statusHtml = `<span class="badge status-outline info">${regStart.getMonth() + 1}.${regStart.getDate()}ë¶€í„° ì ‘ìˆ˜</span>`;
        } else if (regEnd && now <= regEnd) {
            const diffMs = regEnd - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffDays >= 20) {
                statusHtml = `<span class="badge status-outline success">ì ‘ìˆ˜ì¤‘</span>`;
            } else if (diffDays >= 1) {
                statusHtml = `<span class="badge status-outline warning">ë§ˆê° ${diffDays}ì¼ì „</span>`;
            } else {
                statusHtml = `<span class="badge status-outline warning">ë§ˆê° ${diffHours}ì‹œê°„ì „</span>`;
            }
        } else if (regEnd && now > regEnd) {
            statusHtml = `<span class="badge status-outline light">ì ‘ìˆ˜ë§ˆê°</span>`;
        } else if (eventDateStr && new Date(eventDateStr) < now) {
            statusHtml = `<span class="badge status-outline light">ì¢…ë£Œ</span>`;
        } else {
            statusHtml = '';
        }

        statusDiv.html(statusHtml);

        // ë‚ ì§œ íŒŒì‹± í•¨ìˆ˜ (YYYY.MM.DD [ì˜¤ì „/ì˜¤í›„ HH:MM:SS] ì§€ì›)
        function parseDate(str) {
            if (!str) return null;
            str = str.trim();
            // ì˜ˆ: 2025. 6. 14 ì˜¤ì „ 12:00:00 ë˜ëŠ” 2025.06.14 ì˜¤í›„ 3:30:00
            const regex = /^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})(?:\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/;
            const match = str.match(regex);
            if (match) {
                let year = Number(match[1]);
                let month = Number(match[2]) - 1;
                let day = Number(match[3]);
                let hour = 0, minute = 0, second = 0;
                if (match[4]) {
                    hour = Number(match[5]);
                    if (match[4] === 'ì˜¤í›„' && hour < 12) hour += 12;
                    if (match[4] === 'ì˜¤ì „' && hour === 12) hour = 0;
                    minute = Number(match[6]);
                    second = match[7] ? Number(match[7]) : 0;
                }
                return new Date(year, month, day, hour, minute, second);
            }
            // ê¸°ë³¸ YYYY.MM.DD
            const parts = str.split('.');
            if (parts.length >= 3) {
                return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
            return null;
        }
    });

    // ì§€ì—­ ë“œë¡­ë‹¤ìš´ ë™ì  ì˜µì…˜ ì¶”ê°€
    const $regionMenu = $('#regionDropdownMenu');
    $regionMenu.find('.dynamic-region').remove();
    Array.from(allRegions).sort().forEach(region => {
        $regionMenu.append(`<li class="dynamic-region"><a class="dropdown-item region-filter-item" href="#" data-region="${region}">${region}</a></li>`);
    });

    // ì½”ìŠ¤ ë“œë¡­ë‹¤ìš´ ê³ ì • ì˜µì…˜ë§Œ ì‚¬ìš© (ë™ì  ìƒì„± X)
    const $courseMenu = $('#courseDropdownMenu');
    $courseMenu.empty();

    // ì½”ìŠ¤ ë“œë¡­ë‹¤ìš´ ê³ ì • ì˜µì…˜ì— íŠ¸ë ˆì¼ëŸ¬ë‹ ì¶”ê°€
    const courseOptions = [
        { value: 'all', label: 'ì „ì²´ ì½”ìŠ¤' },
        { value: 'Full', label: 'Full' },
        { value: 'Half', label: 'Half' },
        { value: '10km', label: '10km' },
        { value: '5km', label: '5kmì´í•˜' },
        { value: 'trail', label: 'íŠ¸ë ˆì¼ëŸ¬ë‹' }, // ì¶”ê°€
        { value: 'etc', label: 'ê¸°íƒ€' }
    ];

    courseOptions.forEach(item => {
        $courseMenu.append(`
            <li>
              <label class="dropdown-item mb-1">
                <input type="checkbox" class="form-check-input me-1 course-filter-checkbox" value="${item.value}"> ${item.label}
              </label>
            </li>
        `);
    });

    // ì§€ì—­ í•„í„° ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸
    $(document).on('click', '.region-filter-item', function(e) {
        e.preventDefault();
        const region = $(this).data('region');
        $('#regionDropdownBtn').text(region === 'all' ? 'ì „ì²´ ì§€ì—­' : $(this).text());
        $('#regionDropdownBtn').data('selected-region', region);
        filterCards();
    });

    // ì½”ìŠ¤ í•„í„° ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ (ë‹¤ì¤‘ì„ íƒ)
    $(document).on('change', '.course-filter-checkbox', function() {
        // "ì „ì²´ ì½”ìŠ¤" ì²´í¬ ì‹œ ë‚˜ë¨¸ì§€ í•´ì œ, ë‚˜ë¨¸ì§€ ì²´í¬ ì‹œ "ì „ì²´ ì½”ìŠ¤" í•´ì œ
        if ($(this).val() === 'all') {
            if ($(this).is(':checked')) {
                $('.course-filter-checkbox').not(this).prop('checked', false);
            }
        } else {
            $('.course-filter-checkbox[value="all"]').prop('checked', false);
        }
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const checked = $('.course-filter-checkbox:checked').map(function(){ return $(this).parent().text().trim(); }).get();
        $('#courseDropdownBtn').text(checked.length === 0 || checked.includes('ì „ì²´ ì½”ìŠ¤') ? 'ì „ì²´ ì½”ìŠ¤' : checked.join(', '));
        filterCards();
    });

    // ì§€ë‚œëŒ€íšŒ ë³´ê¸° ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸
    $('#showPastSwitch').on('change', function() {
        filterCards();
    });

    // ìµœì´ˆ ë¡œë”© ì‹œì—ë„ í•„í„° ì ìš©
    $(function() {
        filterCards();
    });

    function filterCards() {
        const selectedRegion = $('#regionDropdownBtn').data('selected-region') || 'all';
        const checkedCourses = $('.course-filter-checkbox:checked').map(function(){ return $(this).val(); }).get();
        const showPast = $('#showPastSwitch').is(':checked');
        const today = new Date();
        today.setHours(0,0,0,0);

        $('.marathon-card').each(function() {
            const cardRegionType = $(this).data('region-type');
            const cardRegionName = $(this).data('region-name');
            const courseRaw = ($(this).data('course') || '').toLowerCase();
            let show = true;

            // ì§€ì—­ í•„í„°
            if (selectedRegion === 'metro') {
                show = show && (cardRegionType === 'metro');
            } else if (selectedRegion === 'nonmetro') {
                show = show && (cardRegionType === 'nonmetro');
            } else if (selectedRegion !== 'all') {
                show = show && (cardRegionName === selectedRegion);
            }

            // ì½”ìŠ¤ í•„í„° (ë‹¤ì¤‘ì„ íƒ)
            if (checkedCourses.length > 0 && !checkedCourses.includes('all')) {
                let courseMatch = false;
                // ì½”ìŠ¤ ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë¶„ë¦¬ (ê³µë°± ì œê±°)
                const courseArr = courseRaw.split(',').map(c => c.trim());
                checkedCourses.forEach(courseFilter => {
                    if (courseFilter === 'Full' && courseArr.includes('full')) courseMatch = true;
                    else if (courseFilter === 'Half' && courseArr.includes('half')) courseMatch = true;
                    else if (courseFilter === '10km' && courseArr.includes('10km')) courseMatch = true;
                    else if (courseFilter === '5km' && courseArr.includes('5km')) courseMatch = true;
                    else if (courseFilter === 'trail') {
                        // ëŒ€íšŒëª…ì— 'íŠ¸ë ˆì¼' ë˜ëŠ” 'trail' í¬í•¨ ì‹œë§Œ í‘œì‹œ
                        const title = $(this).find('h5').text();
                        if (/íŠ¸ë ˆì¼|trail/i.test(title)) courseMatch = true;
                    }
                    else if (courseFilter === 'etc' && courseArr.every(c => !['full', 'half', '10km', '5km', 'trail'].includes(c))) courseMatch = true;
                });
                show = show && courseMatch;
            }

            // ì§€ë‚œëŒ€íšŒ í•„í„° (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€)
            if (!showPast) {
                const eventDateStr = $(this).data('eventdate');
                if (eventDateStr) {
                    const eventDate = new Date(eventDateStr);
                    if (eventDate < today) show = false;
                }
            }

            $(this).toggle(show);
        });
    }

    // ë‚ ì§œ+ìš”ì¼ í¬ë§· í•¨ìˆ˜ (M.DD.ìš”ì¼ í˜•ì‹)
    function formatDateWithDay(dateStr) {
        if (!dateStr) return '';
        const today = new Date();
        let year = today.getFullYear();
        let date = null;
        let str = dateStr.trim().replace(/\s/g, '');
        if (/^\d{1,2}\.\d{1,2}$/.test(str)) {
            // MM.DD
            date = new Date(year, Number(str.split('.')[0]) - 1, Number(str.split('.')[1]));
        } else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(str)) {
            // YYYY.MM.DD
            let parts = str.split('.');
            date = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        }
        if (!date || isNaN(date)) return dateStr;
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        return `${date.getMonth() + 1}.${date.getDate()}.${days[date.getDay()]}`;
    }

    // ëŒ€íšŒëª… ì• ë‘ê¸€ì ì•„ë°”íƒ€
    function getAvatarText(name) {
        if (!name) return '';
        return name.trim().slice(0, 2);
    }

    // 4ê°€ì§€ ì•„ë°”íƒ€ ì»¬ëŸ¬ í´ë˜ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì´ë¦„ë³„ë¡œ ëœë¤í•˜ê²Œ ì ìš©
    function getAvatarColorClass(name) {
        const classes = [
            'avatar-color-periwinkle',
            'avatar-color-ladypink',
            'avatar-color-coral',
            'avatar-color-whisperblue'
        ];
        // ì´ë¦„ì˜ ìœ ë‹ˆì½”ë“œ í•©ìœ¼ë¡œ ì¸ë±ìŠ¤ ê²°ì • (í•­ìƒ ë™ì¼ì¸ì— ë™ì¼ìƒ‰)
        let sum = 0;
        for (let i = 0; i < name.length; i++) sum += name.charCodeAt(i);
        return classes[sum % classes.length];
    }

  }
});

// ë“œë¡­ë‹¤ìš´ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— ì•„ë˜ ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
let dropdownJustClosed = false;

// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ë§Œ ë‹«ê³ , ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ëŠ” ì‹¤í–‰ë˜ì§€ ì•Šê²Œ ì²˜ë¦¬
$(document).on('mousedown', function(e) {
    if (
        $('.dropdown-menu.show').length > 0 &&
        !$(e.target).closest('.dropdown-menu').length &&
        !$(e.target).closest('.dropdown-toggle').length
    ) {
        $('.dropdown-menu.show').each(function() {
            const $menu = $(this);
            const $btn = $menu.siblings('.dropdown-toggle');
            if ($btn.length) {
                $btn.dropdown('hide');
            }
        });
        // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨ í”Œë˜ê·¸ ì„¤ì •
        if ($(e.target).closest('.marathon-card').length) {
            dropdownJustClosed = true;
        }
    }
});

// ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ ë“œë¡­ë‹¤ìš´ì´ ë°©ê¸ˆ ë‹«í˜”ìœ¼ë©´ í´ë¦­ ë¬´ì‹œ
$(document).on('click', '.marathon-card', function(e) {
    if (dropdownJustClosed) {
        dropdownJustClosed = false;
        e.stopImmediatePropagation();
        e.preventDefault();
        return;
    }
    const link = $(this).data('link');
    if (link && !window.getSelection().toString()) {
        window.open(link, '_blank', 'noopener');
    }
});
</script>

</body>
</html>